# ğŸ§¾TIL

## ë‚ ì§œ: 2025-07-07 ğŸ£

## ìƒˆë¡œ ë°°ìš´ ë‚´ìš©

SSE ì‹¤ì‹œê°„ ì±„íŒ… ì±—ë´‡ êµ¬í˜„

- **SSE (Server-Sent Events)** ë°©ì‹ ì‚¬ìš©
- `ReadableStream`ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
- `fetch` + `response.body.getReader()` ì¡°í•©ìœ¼ë¡œ êµ¬í˜„ (`EventSource X)`
- ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ POST ìš”ì²­ â†’ ì‘ë‹µì„ SSE ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ë°›ì•„ì„œ ì‹¤ì‹œê°„ í‘œì‹œ


SSE ì‘ë‹µì„ ë°›ì„ ë•ŒëŠ” ì¼ë°˜ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ `EventSource` ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, `EventSource`ëŠ” GET ìš”ì²­ë§Œ ì§€ì›í•˜ë¯€ë¡œ POST ìš”ì²­ì´ í•„ìš”í•œ ê²½ìš°ì—ëŠ” **`fetch`**ë¥¼ ì‚¬ìš©í•˜ê³  **`response.body.getReader()`**ë¥¼ í†µí•´ ì§ì ‘ ì²­í¬ë¥¼ ì½ì–´ë“¤ì´ëŠ” ë°©ì‹ìœ¼ë¡œ SSEë¥¼ ì²˜ë¦¬í•´ì•¼ í•œë‹¤.

ë°±ì—”ë“œ ëª…ì„¸ì— ë”°ë¼ POST ìš”ì²­ì„ ë³´ë‚´ì•¼ í–ˆìœ¼ë¯€ë¡œ ì§ì ‘ ì²­í¬ë¥¼ ì½ì–´ ë“¤ì´ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸°ë¡œ í–ˆë‹¤.

## ì±—ë´‡ êµ¬í˜„ íë¦„

1. ì±—ë´‡ ì±„íŒ…ë°© ìƒì„±: ìƒì„± ì™„ë£Œ ì‹œ ì–»ëŠ” `sessionId`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì±„íŒ…ë°©ìœ¼ë¡œ ë¼ìš°íŒ…í•œë‹¤.

- ë¼ìš°íŒ…: `/new-chat`
- ìœ ì € ì…ë ¥ ê°’: `problemNumber`, `language`, `mode`, `userCode`

1. ì±„íŒ…ë°© ì…ì¥ ë° ì²« ì‘ë‹µ ìˆ˜ì‹  (ë¼ìš°íŒ…: `/chatbot/:sessionId` )

**POST**

[**/api/backend/v2/chat/session/{sessionId}/start**](http://localhost:8080/swagger-ui/index.html#/ChatBot/startChatSession)

ì±—ë´‡ì„ í˜¸ì¶œí•˜ì—¬ ì±„íŒ…ì„ ì‹œì‘í•˜ëŠ” API

ì±—ë´‡ ì±„íŒ…ë°© ìƒì„± í˜ì´ì§€ì—ì„œ ì–»ì€(ë¼ìš°íŒ… stateë¡œ ë„˜ê¹€) code, mode, sessionId ê¸°ë°˜ìœ¼ë¡œ ì±„íŒ…ì„ ì‹œì‘í•œë‹¤.

1. í›„ì† ì§ˆë¬¸

**POST**

[**/api/backend/v2/chat/session/{sessionId}/followup**](http://localhost:8080/swagger-ui/index.html#/ChatBot/sendMessage)

í›„ì†ì§ˆë¬¸í•˜ëŠ” API

---

## íŠ¸ëŸ¬ë¸” ìŠˆíŒ…

axios ê¸°ë°˜ìœ¼ë¡œ api í†µì‹ ì„ í•˜ê³  ìˆì—ˆê³ , ì¿ í‚¤ ë¦¬í”„ë ˆì‰¬ ë¡œì§ ì—­ì‹œ axios interceptorê°€ ë‹´ë‹¹í•˜ê³  ìˆì—ˆë‹¤. (401 unauthorized ë°œìƒ ì‹œ í† í° ë¦¬í”„ë ˆì‰¬ api í˜¸ì¶œ)

ê·¸ëŸ¬ë‚˜ ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„°ëŠ” ì•„ë˜ì™€ ê°™ì€ ì´ìœ ë¡œ axiosë¡œ ì²˜ë¦¬í•  ìˆ˜ ì—†ë‹¤ê³  í•œë‹¤.

- axios ë‚´ë¶€ì ìœ¼ë¡œ `XMLHttpRequest` ë˜ëŠ” `http` ëª¨ë“ˆ ì‚¬ìš© â†’ **ì„œë²„ ì‘ë‹µ ì „ì²´ë¥¼ ë‹¤ ë³´ë‚´ê³  ë‚˜ì„œ íŒŒì‹±**í•˜ë¯€ë¡œ ìŠ¤íŠ¸ë¦¬ë° ì²­í¬ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŒ

ë°˜ë©´ **fetch**ëŠ” **ReadableStream(ë¸Œë¼ìš°ì €ì—ì„œ ë°ì´í„°ë¥¼ ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ì½ì–´ì˜¬ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê°ì²´)**ì„ ì§€ì›í•œë‹¤. ë”°ë¼ì„œ ì²­í¬ ë‹¨ìœ„ë¡œ ì§ì ‘ ì½ì–´ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

### 1. fetch + reader ì‚¬ìš©í•˜ì—¬ ì²­í¬ ë‹¨ìœ„ë¡œ ì‘ë‹µ ë°›ì•„ ì½ê¸°

```tsx
const response = await fetch(
    `${API_BASE_URL}${API_SUB_URLS_V2}/chat/session/${sessionId}/start`,
    {
      method: 'POST',
      headers: {
        Accept: 'text/event-stream',
      },
      credentials: 'include', // ì¿ í‚¤ í¬í•¨
    }
);

const reader = response.body?.getReader(); // fetchëŠ” ReadableStream ì§€ì›
const decoder = new TextDecoder();

  if (reader) {
    while (true) {
      const { done, value } = await reader.read();
      if (done) {
        setIsLoading(false);
        break;
      }

      const chunk = decoder.decode(value, { stream: true });
      console.log(chunk);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('event:message')) {
          continue;
        }
        if (line.startsWith('data:')) {
          const data = line.substring(5).trim();
          if (data) {
            setMessages(prev =>
              prev.map(msg =>
                msg.id === botMessageId ? { ...msg, content: msg.content + data } : msg
              )
            );
          }
        }
      }
```

ì„œë²„ë¡œë¶€í„° ì˜¤ëŠ” ë°ì´í„°ê°€ `event:message`, `data:` ì™€ ê°™ì€ í˜•ì‹ì´ë¯€ë¡œ ì´ì— ë§ê²Œ ì›í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ì¶”ì¶œí–ˆë‹¤.

### 2. axios â†’ fetchë¡œ ë³€ë™ ë˜ë©° í† í° ê°±ì‹  ë¬¸ì œ


axios interceptorë¡œ í† í° ê°±ì‹  ë¡œì§ì„ ë‹¤ë£¨ë‹¤ë³´ë‹ˆ ë‹¹ì—°íˆ fetchì—ì„œëŠ” ìë™ìœ¼ë¡œ ë¦¬í”„ë ˆì‰¬ê°€ ë˜ì§€ ì•ŠëŠ” í˜„ìƒì´ ìˆì—ˆë‹¤.

ê²°êµ­ ì±—ë´‡ APIë¥¼ ìœ„í•œ í† í° ê°±ì‹  ë¡œì§ì„ êµ¬í˜„í•´ì•¼ í–ˆë‹¤.

ì¦‰ fetch í›„ 401 ì—ëŸ¬ ë°œìƒ ì‹œ í† í°ì„ refresh í•˜ë„ë¡ ì•„ë˜ì™€ ê°™ì´ êµ¬í˜„í•´ë³´ì•˜ë‹¤.

- `fetchStreamWithAuth` : urlê³¼ optionì„ ë°›ì•„ fetchë¥¼ ë‹´ë‹¹í•˜ëŠ” í•¨ìˆ˜

```tsx
// ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬ë¥¼ ìœ„í•œ 401 ì—ëŸ¬ í•¸ë“¤ë§ í•¨ìˆ˜
const fetchStreamWithAuth = async (
  url: string,
  options: RequestInit = {}
): Promise<Response> => {
  try {
    const response = await fetch(url, options);

    if (response.status === 401) {
      // í† í° ë¦¬í”„ë ˆì‹œ ì‹œë„
      const refreshSuccess = await refreshToken();

      if (refreshSuccess) {
        // ë¦¬í”„ë ˆì‹œ ì„±ê³µ ì‹œ ì›ë˜ ìš”ì²­ ì¬ì‹œë„
        return await fetch(url, options);
      } else {
        // ë¦¬í”„ë ˆì‹œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ throw
        throw new Error("Authentication failed");
      }
    }

    return response;
  } catch (error) {
    console.error("Fetch with auth failed:", error);
    throw error;
  }
};

// response ì–»ê¸° : fetchStreamWithAuth í˜¸ì¶œ (api í˜¸ì¶œ)
const response = await fetchStreamWithAuth(
  `${API_BASE_URL}${API_SUB_URLS_V2}/chat/session/${sessionId}/followup`,
  {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Accept: "text/event-stream",
    },
    credentials: "include",
    body: JSON.stringify({
      content: userMessage,
    }),
  }
);
```

ì´ë•Œ 401 ë°œìƒ ì‹œ ë¦¬í”„ë ˆì‰¬ apië¥¼ í˜¸ì¶œí•˜ëŠ” `refreshToken()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤.

- `refreshToken` : refresh apië¥¼ í˜¸ì¶œí•˜ê³ , ì‹¤íŒ¨ ì‹œ(ì„œë²„ ì˜¤ë¥˜ë‚˜ ë¦¬í”„ë ˆì‰¬ ì—ëŸ¬ ë“±) ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œí‚¨ë‹¤.

```tsx
const refreshToken = async (): Promise<boolean> => {
  try {
    const response = await fetch(
      `${API_BASE_URL}${API_SUB_URLS}/auth/refresh`,
      {
        method: "POST",
        credentials: "include",
      }
    );

    if (response.ok) {
      return true;
    } else {
      // ë¦¬í”„ë ˆì‹œ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      navigate("/");

      return false;
    }
  } catch (error) {
    console.error("Token refresh failed:", error);
    navigate("/");

    return false;
  }
};
```

## ì˜¤ëŠ˜ì˜ íšŒê³ 

ì–¼ë§ˆ ì „ ë´¤ë˜ ì»¨í¼ëŸ°ìŠ¤ ì˜ìƒì—ì„œ fetchì™€ axiosì¤‘ ì¡°ê¸ˆ ë” ë‹¤ì–‘í•œ ìƒí™©ì— ëŒ€ì²˜ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì ì—ì„œ fetchë¡œ ë³€ê²½í–ˆë‹¤ëŠ” ì´ì•¼ê¸°ë¥¼ ë“¤ì€ ì ì´ ìˆë‹¤.

ì´ëŸ¬í•œ ì ì—ì„œ fetchê°€ í™•ì‹¤íˆ ê·¼ë³¸ì ì¸ ë¹„ë™ê¸° í•¨ìˆ˜ì¸ ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤.

axiosê°€ ë¬´ì¡°ê±´ì ì„ ì˜³ì€ ê²ƒì€ ì•„ë‹ˆêµ¬ë‚˜, ìƒí™©ì— ë§ê²Œ ì˜ ì„ íƒí•´ì•¼ í•¨ì„ ë‹¤ì‹œ ìƒê°í•´ë³´ê²Œ í•˜ëŠ” ê³¼ì œì˜€ë‹¤.
