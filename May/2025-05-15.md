# 🧾TIL

## 날짜: 2025-05-15 🙄

## 새로 배운 내용

## 💻 현재 구현 방식

- `useFileInput` 훅을 사용하여 파일 입력 관리
- FormData 객체에 파일(`profileImg`)과 기타 정보(`nickname`, `statusMsg`)를 추가
- `completeProfile` API 함수를 통해 서버로 `multipart/form-data` 형식으로 전송

## 🔎 문제 원인

- 서비스 출시 후, 이미지를 백엔드 서버에 보내 처리하므로 **트래픽이 조금이라도 몰리면 에러가 발생하거나, 매우 느려졌음**
- 이미지 사이즈에 따라 413 에러가 발생하였음 (nginx 문제, 해결 완료)

## 🐾 구현

프론트엔드에서 이미지를 S3에 전송하는 게 더 효율적이고 사용자 경험상 좋을 것 같아서, S3 접근 주체를 백엔드 → 프론트엔드로 변경하고자 하였다.

프론트에서 직접 이미지를 업로드 하는 방법으로 아래 두 가지 방법이 있다고 생각하였다.

1. S3 환경 변수를 프론트 어플리케이션에 환경 변수로 저장해서 aws-sdk 직접 사용
2. presigned url을 백엔드로부터 받아서 프론트에서 S3에 이미지 업로드

⇒ 그러나 프론트에서 s3 환경 변수를 저장하는 것은 보안 상 좋지 않다고 판단하여 2번을 선택했다.

- `프론트` → `백엔드` presigned url 요청
- `백엔드` → `S3` AWS 인증 정보와 함께 presigned url 요청
- `S3` → `백엔드` presigned url 발급
- `백엔드` → `프론트` presigned url 제공
- `프론트` → `S3` presigned url 이용해서 이미지 업로드

—> Presigned URL 을 사용하는 이유는 프론트엔드에서 S3 버킷에 직접 파일을 업로드 할 수 있는 권한을 주기 위해서다.

하지만 단점은 결국 백엔드에 presigned url을 요청하고, 백엔드가 S3로부터 받은 url을 프론트가 매번 받아서 업로드 한다는 건데 과연 매번 이렇게 요청하는 게 맞나? 싶었다.

그렇다고 .env 파일에 환경 변수를 늘려서 위험을 감수해야 할까?라는 생각이 들었다.

GPT에 물어보니

**근데 액세스 키를 프론트 환경 변수로 안전하게 저장한다고 해도 presigned url을 사용하지 않는 것이 문제가 될까?**

### 🤖 ChatGPT의 말:

**된다. 문제 확실히 된다.** 액세스 키를 프론트의 `.env`에 저장한다고 해도, **빌드된 번들에 고스란히 포함**된다. 즉, 누구나 개발자 도구로 보고 **네 AWS 권한을 탈취할 수 있다.**

이렇게 심각하게 얘기하는데.. 진짜로 그럴까 싶어서 탈취할 수 있나 직접 확인해보았다.

## 🫵🏻.env 파일의 환경변수들이 노출되어 있다

client_id 의 경우 프론트에서 환경변수로 넣어 놓은 건데, 이렇게 개발자 도구 내에서 하드 코딩 되어 노출됐다.

확실히 프론트에 환경 변수를 넣을 땐 넣어도 되는 정보인지 꼭 확인해야 할 것 같다.

(여담이지만 다른 프로젝트에서 구글 지도 키를 github secrets에 넣어 놓고 CI/CD 배포까지 했는데 진짜 서늘해져서 바로 다시 찾아봤는데 Google Maps 키는 **기본적으로 제한이 없는 공개키이고, 반드시 도메인 제한 설정하면 된다고.. 한다.)**

**[vite 공식 문서 中]**
Vite 소스 코드에 노출되는 모든 환경 변수는 번들링 시 포함되게 됩니다. 따라서, `VITE_*` 환경 변수에는 민감한 정보들이 *포함되어서는 안됩니다*.

## 오늘의 회고

지금껏 이미지 처리는 백엔드에서 해야만 하는 줄 알았는데, 이미지가 크고 트래픽이 몰릴수록 이미지를 전송하는 시간이 길어져 유저 경험에 좋지 않았다. 물론 에러도 발생했다 ..

확실히 서비스 출시를 하다보니 상상도 못했던 많은 이슈와 에러가 발생하는 것 같다.

아무튼, 프론트엔드에서 S3에 바로 업로드 하는 방안을 찾았고, 이제 이대로 마이그레이션 해보려고 한다.
