# ğŸ§¾TIL

## ë‚ ì§œ: 2025-08-03 ğŸ£

# ë“¤ì–´ê°€ê¸° ì „ - Fiberì˜ ë“±ì¥

`fiber`ëŠ” ì¼ë°˜ì ì¸ ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ì§€ë§Œ, ë³¸ì§ˆì ìœ¼ë¡œëŠ” **UI ìƒíƒœë¥¼ ê°’ìœ¼ë¡œ í‘œí˜„í•œ êµ¬ì¡°ì²´**ë‹¤.

ReactëŠ” ì´ Fiber ë…¸ë“œë“¤ì„ ì—°ê²°í•´ ë Œë” íŠ¸ë¦¬(ê°€ìƒ DOM íŠ¸ë¦¬)ë¥¼ êµ¬ì„±í•˜ê³ , ì´ë¥¼ ì‹¤ì œ DOMê³¼ ë¹„êµ(diff)í•˜ì—¬ ë³€ê²½ì‚¬í•­ë§Œì„ ë°˜ì˜í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë Œë”ë§ íš¨ìœ¨ì„ ë†’ì¸ë‹¤.

React ê³µì‹ ë¬¸ì„œì—ì„œëŠ” **ë Œë”ë§**ì„ **â€œìƒíƒœ ì—…ë°ì´íŠ¸ê°€ ë°œìƒí•œ ì»´í¬ë„ŒíŠ¸ë¥¼ ì¬ê·€ì ìœ¼ë¡œ í˜¸ì¶œí•˜ë©° ë³€ê²½ ì‚¬í•­ì„ ê³„ì‚°í•˜ëŠ” ê³¼ì •â€**ì´ë¼ê³  ì„¤ëª…í•œë‹¤.

í•˜ì§€ë§Œ ë‚˜ëŠ” ì´ ì„¤ëª…ì´ ë„ˆë¬´ ì¶”ìƒì ì–´ì„œ ì´í•´í•˜ê¸° ì–´ë ¤ì› ë‹¤..

ã€ëª¨ë˜ React ë”¥ ë‹¤ì´ë¸Œã€ë„ ì°¸ê³ í•´ë´¤ì§€ë§Œ, ë‚´ë¶€ êµ¬ì¡°ë¥¼ ëª¨ë¥¸ ì±„ ê°œë…ë§Œ ë‹¤ë£¨ë‹¤ ë³´ë‹ˆ ì˜¤íˆë ¤ ë” í˜¼ë€ìŠ¤ëŸ¬ì› ë‹¤.

ê·¸ë˜ì„œ, **ì§ì ‘ React ì½”ë“œë¥¼ ëœ¯ì–´ë³´ê¸°ë¡œ ê²°ì‹¬í–ˆë‹¤.** ğŸ« 

# FiberNode êµ¬ì¡°

- https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiber.js

```jsx
function FiberNode(
  this: $FlowFixMe,
  tag: WorkTag, // ì–´ë–¤ íƒ€ì…ì˜ ì»´í¬ë„ŒíŠ¸ì¸ì§€ (ì˜ˆ: FunctionComponent ë“±)
  pendingProps: mixed, // ìƒˆë¡œ ë Œë”ë§ì— ì‚¬ìš©ë  props
  key: null | string, // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ë“±ì—ì„œ ì‚¬ìš©í•˜ëŠ” key
  mode: TypeOfMode // concurrent ëª¨ë“œì¸ì§€ ë“±ì˜ ì„¤ì •
) {
  // ì‹¤ì œ ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ (ì˜ˆ: DOM ë…¸ë“œë‚˜ í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤)
  this.tag = tag;
  this.key = key;
  this.elementType = null; // JSX íƒ€ì… ê·¸ëŒ€ë¡œ ìœ ì§€
  this.type = null; // ì‹¤ì œ íƒ€ì… (í•¨ìˆ˜, í´ë˜ìŠ¤, ë¬¸ìì—´ ë“±)
  this.stateNode = null; // ì‹¤ì œ DOM ë…¸ë“œ ë˜ëŠ” í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤

  // íŠ¸ë¦¬ êµ¬ì¡° ì •ë³´
  this.return = null; // ë¶€ëª¨ Fiber
  this.child = null; // ì²« ë²ˆì§¸ ìì‹ Fiber
  this.sibling = null; // ë‹¤ìŒ í˜•ì œ Fiber
  this.index = 0; // ìœ„ì¹˜ ì¸ë±ìŠ¤ (ë°°ì—´ ë Œë”ë§ ì‹œ)

  // ref ê´€ë ¨ ì •ë³´
  this.ref = null;
  this.refCleanup = null;

  // ìƒíƒœ ë° props ê´€ë ¨
  this.pendingProps = pendingProps; // ìƒˆë¡œ ì ìš©ë  props
  this.memoizedProps = null; // ì´ì „ì— ë Œë”ì— ì‚¬ìš©ëœ props
  this.updateQueue = null; // ìƒíƒœ ì—…ë°ì´íŠ¸ í
  this.memoizedState = null; // ì´ì „ ë Œë”ë§ ì‹œì˜ state
  this.dependencies = null; // context ë“±ì˜ ì˜ì¡´ì„±

  this.mode = mode; // Fiber ëª¨ë“œ (StrictMode ë“±)

  // ì»¤ë°‹ ë‹¨ê³„ì—ì„œ í•„ìš”í•œ ë³€ê²½ ì •ë³´
  this.flags = NoFlags; // í˜„ì¬ ë…¸ë“œì˜ ë³€ê²½ ì‚¬í•­ í”Œë˜ê·¸
  this.subtreeFlags = NoFlags; // ìì‹ ë…¸ë“œë“¤ì˜ ë³€ê²½ ì‚¬í•­ í”Œë˜ê·¸
  this.deletions = null; // ì‚­ì œë  ìì‹ë“¤

  // ìŠ¤ì¼€ì¤„ë§ ê´€ë ¨
  this.lanes = NoLanes; // ì´ ë…¸ë“œì˜ ì‘ì—… ìš°ì„ ìˆœìœ„
  this.childLanes = NoLanes; // ìì‹ íŠ¸ë¦¬ ë‚´ ì‘ì—… ìš°ì„ ìˆœìœ„

  // ì´ì „ ë Œë” íŠ¸ë¦¬ì˜ Fiber
  this.alternate = null;

  // ê°œë°œ/ì„±ëŠ¥ ì¸¡ì •ìš© í•„ë“œ
  if (enableProfilerTimer) {
    // ...
  }

  // ë””ë²„ê¹…ìš© ì •ë³´ (ê°œë°œ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©)
  if (__DEV__) {
    // ...
  }
}
```

(ì½”ë“œë¡œ ë°”ë¡œë°”ë¡œ ë³´ëŠ” ê²Œ ë³´ê¸° í¸í•  ê²ƒ ê°™ì•„ì„œ React ì½”ë“œë¥¼ ê°€ì ¸ì™€ í•œê¸€ë¡œ ì£¼ì„ì„ ë‹¬ì•„ ë´¤ë‹¤.)

React ë Œë”ë§ í”„ë¡œì„¸ìŠ¤ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ Fiber ë…¸ë“œì˜ êµ¬ì„±ì´ë‹¤.

React v15ê¹Œì§€ëŠ” ë Œë”ë§ì´ ë™ê¸°ì ìœ¼ë¡œ ì´ë£¨ì–´ì¡ŒëŠ”ë°, Fiber ì•„í‚¤í…ì²˜ê°€ ë„ì…ë˜ë©´ì„œ ìš°ì„ ìˆœìœ„ì™€ ê°™ì€ ì„¸ë°€í•œ ì œì–´ë„ ê°€ëŠ¥í•˜ê²Œ ëë‹¤. ë¹„ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ëœ ê²ƒì´ë‹¤.

ì˜¤ëŠ˜ì€ ì´ëŸ¬í•œ **Fiberì™€ ë™ê¸° ë Œë”ë§ í”„ë¡œì„¸ìŠ¤**ë¥¼ ì´í•´í•´ë³¼ ì˜ˆì •ì´ë¯€ë¡œ, ë‚˜ë¨¸ì§€ dev ëª¨ë“œë‚˜ profiler ë“±ë“±ì˜ ë¡œì§ì´ë‚˜ ì†ì„±ë“¤ì€ ì¡°ê¸ˆ íë¦° ëˆˆ í•´ë³¼.. ìƒê°ì´ë‹¤.

> **ë Œë”ì˜ ì˜ë¯¸ì™€ fiber êµ¬ì¡°ì˜ ê´€ê³„**

React ê³µì‹ë¬¸ì„œì—ì„œëŠ” "ë Œë”ë§ì€ ìƒíƒœê°€ ë°”ë€ ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¨ë¡€ë¡œ í˜¸ì¶œí•˜ê³ , ê·¸ì— ë”°ë¥¸ ë³€ê²½ì‚¬í•­ì„ ê³„ì‚°í•˜ëŠ” ê³¼ì •"ì´ë¼ê³  ì„¤ëª…í•œë‹¤.

ê·¸ëŸ°ë° ì–´ë–»ê²Œ ì»´í¬ë„ŒíŠ¸ë¥¼ "ì°¨ë¡€ë¡œ í˜¸ì¶œ"í•  ìˆ˜ ìˆì„ê¹Œ?

```jsx
this.return = null; // ë¶€ëª¨ Fiber
this.child = null; // ì²« ë²ˆì§¸ ìì‹ Fiber
this.sibling = null; // ë‹¤ìŒ í˜•ì œ Fiber
this.index = 0; // ìœ„ì¹˜ ì¸ë±ìŠ¤ (ë°°ì—´ ë Œë”ë§ ì‹œ)
```

ê° FiberëŠ” `return`, `child`, `sibling` í¬ì¸í„°ë¥¼ í†µí•´ **íŠ¸ë¦¬ íƒìƒ‰ì´ ê°€ëŠ¥**í•˜ê²Œ ë˜ì–´ ìˆë‹¤.

ì¶”í›„ì— ë” ìì„¸íˆ ì„¤ëª…í•˜ê² ì§€ë§Œ, childë¥¼ ë”°ë¼ íƒìƒ‰í•˜ë©° ì»´í¬ë„ŒíŠ¸ë¥¼ í˜¸ì¶œí•˜ê³ , childê°€ ì—†ìœ¼ë©´ sibling, ë” ì´ìƒ ì—†ìœ¼ë©´ ë‹¤ì‹œ ë¶€ëª¨ ë…¸ë“œë¡œ return ëœë‹¤.

ì´ë•Œ ì°¨ë¡€ë¡œ í˜¸ì¶œí•˜ëŠ” ê³¼ì • ì¤‘ì— ë³€ê²½ ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°(flagë¡œ ì²˜ë¦¬ ë˜ì–´ ìˆìŒ)ì—ë§Œ ì—…ë°ì´íŠ¸ ê³¼ì •ì„ ìˆ˜í–‰í•˜ê³ , ì—†ëŠ” ê²½ìš°ì—ëŠ” ë°”ë¡œ return ë˜ì–´ ìµœì í™”í•œë‹¤.

# **ì¶”ìƒí™” 1) Fiber íŠ¸ë¦¬ : currentì™€ WorkInProgess**

ë¨¼ì € ë°”ë¡œ ì½”ë“œì— ë“¤ì–´ê°€ë³´ê¸° ì „, Reactì—ì„œëŠ” **ë‘ ê°œì˜ Fiber íŠ¸ë¦¬ë¥¼ ë‘ê³  ë Œë” ì‘ì—…ì„ ì§„í–‰í•œë‹¤ëŠ” ê²ƒ(= ë”ë¸” ë²„í¼ë§)**ì„ ë¯¸ë¦¬ ì•Œë©´ ë” ì¢‹ì„ ê²ƒ ê°™ë‹¤.

ìœ„ì˜ Fiber ë…¸ë“œë“¤ë¡œ íŠ¸ë¦¬ê°€ êµ¬ì„±ë˜ëŠ”ë°,

Fiber íŠ¸ë¦¬ì—ëŠ” ë‘ ì¢…ë¥˜ê°€ ìˆë‹¤. **`current` , `WorkInProgress`**

- `current` ëŠ” í˜„ì¬ í™”ë©´ì— ë°˜ì˜ëœ ë Œë” íŠ¸ë¦¬
- `WorkInProgress` ëŠ” ë‹¤ìŒ ë Œë”ë§ì„ ìœ„í•´ í˜„ì¬ ì‘ì—… ì¤‘ì¸ íŠ¸ë¦¬ë‹¤.

ë Œë”ë§ì´ íŠ¸ë¦¬ê±° ë˜ë©´ `current` íŠ¸ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ `WorkInProgress` íŠ¸ë¦¬ë¥¼ ìƒì„±í•œë‹¤.

ê·¸ëŸ°ë° ì¬ë°ŒëŠ” ì ì€ **ì´ ë‘ ê°€ì§€ì˜ fiber íŠ¸ë¦¬ë¥¼ ê³„ì†í•´ì„œ ì¬ì‚¬ìš© ëœë‹¤ëŠ” ê²ƒ**ì´ë‹¤. (ìµœì í™”)

ì–´ë–»ê²Œ ì¬ì‚¬ìš©ì´ ê°€ëŠ¥í•œê°€ í•˜ë©´,

1. ë Œë”ë§ì´ ë°œìƒí•˜ë©´ `current`ë¥¼ ë°”íƒ•ìœ¼ë¡œ `workInProgress`ë¥¼ ìƒì„±í•œë‹¤.
2. ë Œë”ë§ê³¼ ì»¤ë°‹ì´ ëë‚˜ë©´, `workInProgress`ëŠ” ìƒˆë¡œìš´ `current` ê°€ ëœë‹¤.
3. ë‹¤ìŒ ë Œë”ë§ ë•ŒëŠ” ì´ `current`ê°€ ë‹¤ì‹œ `workInProgress`ë¥¼ ë§Œë“œëŠ” ë° ì‚¬ìš©ëœë‹¤.

â‡’ í•œ ë²ˆ ë§Œë“¤ê³  ëì´ ì•„ë‹ˆë¼, ì»¤ë°‹ ë‹¨ê³„ê¹Œì§€ ëë‚´ê³  ë‚˜ë©´ `WorkInProgress` íŠ¸ë¦¬ê°€ `current` íŠ¸ë¦¬ê°€ ëœë‹¤.

ì´ì „ì˜ `current` íŠ¸ë¦¬ëŠ” ë‹¤ìŒ ë Œë”ë§ ì‹œì— ì¬ì‚¬ìš© í•œë‹¤.

ì´ë¥¼ ê°€ëŠ¥í•˜ë„ë¡ ì—°ê²°í•´ë‘ëŠ” ê²ƒì´ `alternate` ë‹¤.

```jsx
// ì´ì „ ë Œë” íŠ¸ë¦¬ì˜ Fiber
this.alternate = null;
```

ì•ì„  fiber ë…¸ë“œì˜ ìš” `alternate` ëŠ” ë°”ë¡œ fiber ë…¸ë“œë¥¼ ì¬ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì—°ê²°í•´ ë†“ëŠ” ì†ì„±ì¸ ê²ƒì´ë‹¤.

# ì¶”ìƒí™” 2) Fiber ì²˜ë¦¬ íë¦„

[ì¶”ìƒí™” 1] ì˜ ë‚´ìš©ì„ ìš”ì•½í•˜ë©´,

- ìœ„ì˜ íŒŒì´ë²„ ê°ì²´ê°€ ëª¨ì—¬ íŠ¸ë¦¬ë¥¼ êµ¬ì„±í•œë‹¤.
- íŒŒì´ë²„ì—ëŠ” ë‘ ê°œì˜ íŠ¸ë¦¬ êµ¬ì¡°ê°€ ìˆëŠ”ë°, íŠ¸ë¦¬ë¥¼ ì‚¬ìš©í•´ í˜„ì¬ êµ¬ì¡°(`current`)ì™€ ë Œë”ë§ ë˜ê³  ìˆëŠ” êµ¬ì¡°(`WorkInProgess`)ë¥¼ ê´€ë¦¬í•´, íŒŒì´ë²„ íŠ¸ë¦¬ë¥¼ ê°±ì‹ í•œë‹¤. (íŒŒì´ë²„ëŠ” ì¬ì‚¬ìš©ëœë‹¤!)
- `WorkInProgress`ì˜ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ê³  ì»¤ë°‹ë˜ë©´, `WorkInProgess`ê°€ `current` ê°€ ëœë‹¤.

ì´ì œ ì´ íŠ¸ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ ì–´ë–»ê²Œ ë Œë”ê°€ ìˆ˜í–‰ë˜ëŠ”ì§€ í° ê·¸ë¦¼ì„ ê·¸ë ¤ ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

## íŒŒì´ë²„ ì‘ì—… ìˆœì„œ

```jsx
<A1>
  <B1>ì•ˆë…•í•˜ì„¸ìš”</B1>
  <B2>
    <C1>
      <D1 />
      <D2 />
    </C1>
  </B2>
  <B3 />
</A1>
```

<ëª¨ë˜ ë¦¬ì•¡íŠ¸ ë”¥ ë‹¤ì´ë¸Œ> 141ìª½ì˜ ì˜ˆì œì´ë‹¤.

- íë¦„

```
beginWork(A1)
  beginWork(B1)         â†’ ìì‹ ì—†ìŒ â†’ completeWork(B1)
  beginWork(B2)
    beginWork(C1)
      beginWork(D1)     â†’ ìì‹ ì—†ìŒ â†’ completeWork(D1)
      beginWork(D2)     â†’ ìì‹ ì—†ìŒ â†’ completeWork(D2)
    completeWork(C1)
  completeWork(B2)
  beginWork(B3)         â†’ ìì‹ ì—†ìŒ â†’ completeWork(B3)
completeWork(A1)

commitWork() ìˆ˜í–‰
```

1. ReactëŠ” `beginWork()` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•´ fiberë¥¼ ìˆ˜í–‰
2. ìì‹ì´ ì—†ëŠ” fiberë¥¼ ë§Œë‚˜ë©´ `completeWork()` ì‹¤í–‰í•´ fiber ì‘ì—… ì™„ë£Œ
3. ì´í›„ í˜•ì œê°€ ìˆë‹¤ë©´ í˜•ì œë¡œ ë„˜ì–´ê°€ `beginWork()` ì§„í–‰
4. í˜•ì œê¹Œì§€ ëª¨ë‘ `completeWork()` ë¡œ ëë‚¬ë‹¤ë©´ ë¶€ëª¨ ë…¸ë“œë¡œ ëŒì•„ê°€ `completeWork()`
5. ìµœì¢…ì ìœ¼ë¡œëŠ” `commitWork()`ê°€ ìˆ˜í–‰
6. ì´ë•Œ ë³€ê²½ ì‚¬í•­ì„ ë¹„êµí•´ ë³€ê²½ëœ ë¶€ë¶„ë§Œ DOM ì— ë°˜ì˜

---

ë¨¼ì € ë°”ë¡œ ì½”ë“œë¡œ ë“¤ì–´ê°€ê¸° ë³´ë‹¤ëŠ” ì´í•´í•˜ê¸° ìˆ˜ì›”í•˜ë„ë¡ ì–´ë ¤ìš´ ê°œë…ë“¤ì„ ì¶”ìƒí™”í•´ë³´ì•˜ë‹¤.

ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ ì½”ë“œë¥¼ ëœ¯ì–´ë³´ë ¤ê³  í•œë‹¤.

state ë“±ì´ ë³€ê²½ë˜ì–´ ë¦¬ë Œë”ë§ì„ íŠ¸ë¦¬ê±° í•˜ëŠ” ê²½ìš°, ì–´ë–»ê²Œ ë™ê¸°ì  ë Œë”ë§ì´ ë°œìƒí•˜ê³  ì‹¤ì œ DOMì— ë°˜ì˜í•˜ê²Œ ë˜ëŠ”ì§€ ê·¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ëœ¯ì–´ë³´ì!

# renderRootSync, renderRootConcurrent

ë Œë”ë§ ì‘ì—… ì „ì²´ ì‚¬ì´í´ì„ ê´€ë¦¬í•˜ë©°, ê°ê° ë™ê¸°/ë™ì‹œ ëª¨ë“œ ë Œë”ë§ì„ ìˆ˜í–‰í•œë‹¤.

ì´ ë¶€ë¶„ ëˆˆë¹ ì§ˆ ê²ƒ ê°™ì•˜ì§€ë§ŒğŸ˜‚ ë©˜íƒˆì„ ì¡ê³  ìµœëŒ€í•œ í•„ìš”í•œ ë¶€ë¶„ë§Œ ë³´ê³ ì í–ˆë‹¤..

- `renderRootSync` : ë™ê¸° ë°©ì‹ìœ¼ë¡œ í•œ ë²ˆì— ëê¹Œì§€ ë Œë”ë¥¼ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ (ì¤‘ë‹¨ x)
- `renderRootConcurrent` : ì‘ì—…ì„ ìª¼ê°œ ë Œë” ìˆ˜í–‰ (ì¤‘ë‹¨ ê°€ëŠ¥)

ë‘ ê°€ì§€ê°€ ëª¨ë‘ ì‚¬ìš©ë˜ë©° ê° ìƒí™©ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.

ì¼ë‹¨ ì˜¤ëŠ˜ì€ `renderRootSync` ë™ê¸°ì  ë Œë” & ì»¤ë°‹ ê³¼ì •ì— ëŒ€í•´ ì •ë¦¬í•´ë³´ì•˜ë‹¤.

# renderRootSync

## renderRootSync : ì „ì²´ ë Œë” íë¦„ ê´€ë¦¬

```jsx
function renderRootSync(
  root: FiberRoot,
  lanes: Lanes,
  shouldYieldForPrerendering: boolean,
): RootExitStatus {
  const prevExecutionContext = executionContext;
  executionContext |= RenderContext;

  // ë””ìŠ¤íŒ¨ì²˜ ì„¸íŒ…
  // ...

  // fresh stack ì¤€ë¹„
	 if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {
    // ...

    prepareFreshStack(root, lanes);
  }

  // profiler ì‹œì‘
  // ...

  let didSuspendInShell = false;
  let exitStatus = workInProgressRootExitStatus;

  outer: do {
    try {
      if (
        workInProgressSuspendedReason !== NotSuspended &&
        workInProgress !== null
      ) {
        // Suspenseë¡œ ì¸í•´ ì¤‘ë‹¨ëœ ê²½ìš° ì²˜ë¦¬
        // ...
        throwAndUnwindWorkLoop(...);
        if (shouldYieldForPrerendering && workInProgressRootIsPrerendering) {
          exitStatus = RootInProgress;
          break outer;
        }
        break;
      }

      // Fiber ìˆœíšŒí•˜ë©° ë Œë”ë§ ìˆ˜í–‰
      workLoopSync();
      exitStatus = workInProgressRootExitStatus;
      break;
    } catch (thrownValue) {
      // ì˜ˆì™¸ ì²˜ë¦¬
      handleThrow(root, thrownValue);
    }
  } while (true);

  // shellì—ì„œ suspendë˜ì—ˆëŠ”ì§€ ì²´í¬
  if (didSuspendInShell) {
    root.shellSuspendCounter++;
  }

  // ì»¨í…ìŠ¤íŠ¸ ë° ë””ìŠ¤íŒ¨ì²˜ ì •ë¦¬
  // ...

  // profiler ì¢…ë£Œ
  // ...

  if (workInProgress !== null) {
    // íŠ¸ë¦¬ ì™„ì„± ëª»í•¨ (ì¤‘ë‹¨ëœ ìƒíƒœ)
    // ...
  } else {
    // íŠ¸ë¦¬ ì™„ì„±ë¨ â†’ ì‘ì—… ì •ë¦¬
    workInProgressRoot = null;
    workInProgressRootRenderLanes = NoLanes;
    finishQueueingConcurrentUpdates();
  }

  return exitStatus;
}

```

ë¨¼ì € `prepareFreshStack` í†µí•´ WorkInProgress íŠ¸ë¦¬ë¥¼ ìƒì„±í•œë‹¤.

ë˜, `workLoopSync()`ë¥¼ í†µí•´ ì´ ìƒì„±ëœ íŠ¸ë¦¬ë¥¼ ìˆœíšŒí•˜ë©° ë™ê¸°ì ìœ¼ë¡œ ë Œë”ë§ì„ ìˆ˜í–‰í•œë‹¤ëŠ” ê²ƒì„ í™•ì¸í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤.

## prepareFreshStack

```jsx
function prepareFreshStack(root: FiberRoot, lanes: Lanes): Fiber {
  // profiler íƒ€ì´ë¨¸ ë° ì„±ëŠ¥ íŠ¸ë˜í‚¹ ê´€ë ¨ ì²˜ë¦¬ (ìƒëµ)
  if (enableProfilerTimer && enableComponentPerformanceTrack) {
    // ...
  }

  // ì´ì „ì— ì„¤ì •ëœ timeout, ì»¤ë°‹ ì·¨ì†Œ í•¨ìˆ˜ ì œê±°
  const timeoutHandle = root.timeoutHandle;
  if (timeoutHandle !== noTimeout) {
    root.timeoutHandle = noTimeout;
    cancelTimeout(timeoutHandle);
  }

  const cancelPendingCommit = root.cancelPendingCommit;
  if (cancelPendingCommit !== null) {
    root.cancelPendingCommit = null;
    cancelPendingCommit();
  }

  // WIP stack ì´ˆê¸°í™” ë° ì„¤ì •
  resetWorkInProgressStack();
  workInProgressRoot = root;
  const rootWorkInProgress = createWorkInProgress(root.current, null);
  workInProgress = rootWorkInProgress;
  workInProgressRootRenderLanes = lanes;
  workInProgressSuspendedReason = NotSuspended;
  workInProgressThrownValue = null;
  workInProgressRootDidSkipSuspendedSiblings = false;
  workInProgressRootIsPrerendering = checkIfRootIsPrerendering(root, lanes);
  workInProgressRootDidAttachPingListener = false;
  workInProgressRootExitStatus = RootInProgress;
  workInProgressRootSkippedLanes = NoLanes;
  workInProgressRootInterleavedUpdatedLanes = NoLanes;
  workInProgressRootRenderPhaseUpdatedLanes = NoLanes;
  workInProgressRootPingedLanes = NoLanes;
  workInProgressDeferredLane = NoLane;
  workInProgressSuspendedRetryLanes = NoLanes;
  workInProgressRootConcurrentErrors = null;
  workInProgressRootRecoverableErrors = null;
  workInProgressRootDidIncludeRecursiveRenderUpdate = false;

  // ì–½íŒ lanes (entangled lanes) ì„¤ì •
  entangledRenderLanes = getEntangledLanes(root, lanes);

  // ë³‘ë ¬ ì—…ë°ì´íŠ¸ í ì²˜ë¦¬
  finishQueueingConcurrentUpdates();

  if (__DEV__) {
    resetOwnerStackLimit();
    ReactStrictModeWarnings.discardPendingWarnings();
  }

  return rootWorkInProgress;
}
```

ì´ í•¨ìˆ˜ì—ì„œëŠ” workInProgess ì´ˆê¸°í™” ë° ì´ì „ ë Œë” ìƒíƒœ ì •ë¦¬ ë“±ì˜ ë¡œì§ì„ ë‹´ë‹¹í•œë‹¤.

createWorkInProgressë¼ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ”ë°, ì´ì— ëŒ€í•´ì„  ë°‘ì—ì„œ ë” ìì„¸íˆ ì‚´í´ë³´ë ¤ê³  í•œë‹¤.

## createWorkInProgress

ì´ì œ current íŠ¸ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë Œë” ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ workInProgressíŠ¸ë¦¬ë¥¼ ì–´ë–»ê²Œ ìƒì„±í•˜ëŠ”ì§€ ì‚´í´ë³´ì.

current íŠ¸ë¦¬ì˜ fiber ë…¸ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ WorkInProgess íŠ¸ë¦¬ì˜ fiber ë…¸ë“œë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ë‹¤.

ì´ì œ ì¤‘ìš”í•œ ë¶€ë¶„ì„ í•˜ë‚˜ì”© ì‚´í´ë³´ì.

1. **currentëŠ” ê±´ë“¤ì§€ ì•Šê³  ì´ì „ ì‘ì—… íŠ¸ë¦¬ì—ì„œ ë…¸ë“œë¥¼ ê°€ì ¸ì˜¨ë‹¤.**

```jsx
let workInProgress = current.alternate;
```

ì•ì„œ alternateê°€ ë‘ íŠ¸ë¦¬ë¥¼ ì—°ê²°í•˜ëŠ” ì†ì„±ì´ë¼ê³  í–ˆì—ˆë‹¤.

current íŠ¸ë¦¬ëŠ” ê±´ë“¤ì§€ ì•Šê³  workInProgress íŠ¸ë¦¬ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´, ë†€ê³  ìˆëŠ” ë‹¤ë¥¸ fiber ë…¸ë“œë¥¼ ì¬ì‚¬ìš©í•œë‹¤.

1. **(alternateê°€ ì—†ë‹¤ë©´) ìƒˆë¡œ ìƒì„±í•œë‹¤.**

```jsx
if (workInProgress === null) {
  workInProgress = createFiber(
    current.tag,
    pendingProps,
    current.key,
    current.mode
  );
  workInProgress.elementType = current.elementType;
  workInProgress.type = current.type;
  workInProgress.stateNode = current.stateNode;

  if (__DEV__) {
    // DEV-only fields
    // ...
  }

  workInProgress.alternate = current;
  current.alternate = workInProgress;
}
```

`createFiber` í•¨ìˆ˜ë¥¼ í†µí•´ fiber ë…¸ë“œë¥¼ ìƒˆë¡œ ìƒì„±í•œë‹¤.

ê·¸ë¦¬ê³  ì¶”í›„ ì¬ì‚¬ìš©ì„ ìœ„í•´ ì„œë¡œ ì—°ê²°í•´ì£¼ëŠ” ê²ƒë„ ìŠì§€ ì•ŠëŠ”ë‹¤. (alternate)

1. **(ì¬ì‚¬ìš© í–ˆë‹¤ë©´)**

```jsx
else {
    workInProgress.pendingProps = pendingProps;
    workInProgress.type = current.type;
    workInProgress.flags = NoFlags;
    workInProgress.subtreeFlags = NoFlags;
    workInProgress.deletions = null;

    if (enableProfilerTimer) {
      workInProgress.actualDuration = -0;
      workInProgress.actualStartTime = -1.1;
    }
}
```

fiber ë…¸ë“œë¥¼ ì¬ì‚¬ìš©í–ˆë‹¤ë©´, ì´ì „ ë Œë”ì—ì„œ ë‚¨ì•„ ìˆëŠ” ê°’ë“¤ì´ ë‹¤ìŒ ë Œë”ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ **ì¼ë¶€ í•„ë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì´ˆê¸°í™”í•œë‹¤.**

1. **current fiber ë…¸ë“œì˜ ì¼ë¶€ ì†ì„± ê·¸ëŒ€ë¡œ ë³µì‚¬**

```jsx
workInProgress.flags = current.flags & StaticMask;
workInProgress.childLanes = current.childLanes;
workInProgress.lanes = current.lanes;

workInProgress.child = current.child;
workInProgress.memoizedProps = current.memoizedProps;
workInProgress.memoizedState = current.memoizedState;
workInProgress.updateQueue = current.updateQueue;
```

- `childLanes`, `lanes`: ì—…ë°ì´íŠ¸ ìš°ì„ ìˆœìœ„ ê´€ë ¨ ì •ë³´
- `child`, `memoizedProps`, `memoizedState`, `updateQueue`: ë©”ëª¨ì´ì œì´ì…˜ëœ ì •ë³´ë“¤. ë‹¤ìŒ ë Œë”ì—ì„œ ë¹„êµ(diff) ì‹œ í•„ìš”í•˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë³µì‚¬.

1. **dependency ì–•ì€ ë³µì‚¬**

```jsx
const currentDependencies = current.dependencies;
workInProgress.dependencies =
  currentDependencies === null
    ? null
    : __DEV__
    ? {
        lanes: currentDependencies.lanes,
        firstContext: currentDependencies.firstContext,
        _debugThenableState: currentDependencies._debugThenableState,
      }
    : {
        lanes: currentDependencies.lanes,
        firstContext: currentDependencies.firstContext,
      };
```

ë Œë”ë§ ì¤‘ dependenciesëŠ” ë³€ê²½ë˜ë¯€ë¡œ, currentì™€ ê³µìœ  ë˜ë©´ ì•ˆëœë‹¤ê³  í•œë‹¤. (ë²„ê·¸ ë°œìƒ ê°€ëŠ¥ì„±)

ë”°ë¼ì„œ ìƒìˆ˜ `currentDependencies` ë¡œ ì–•ì€ ë³µì‚¬í•´ WorkInProgressì˜ dependenciesì— ë„£ì–´ì¤€ë‹¤.

ê·¸ë¦¬ê³  ê°œë°œí™˜ê²½ì¼ ê²½ìš°ëŠ” `_debugThenableState` ë¼ëŠ” ì†ì„±ì´ ë˜ ë”°ë¡œ ìˆëŠ”ë°, ë””ë²„ê¹…ì— ë„ì›€ì´ ë˜ëŠ” ê²ƒì´ë¼ê³  í•œë‹¤ ..

1. **íŠ¸ë¦¬ êµ¬ì¡° ë³µì‚¬**

```jsx
workInProgress.sibling = current.sibling;
workInProgress.index = current.index;
workInProgress.ref = current.ref;
workInProgress.refCleanup = current.refCleanup;
```

ê·¸ë¦¬ê³  currentì˜ íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•œë‹¤.

- sibling : ë‹¤ìŒ í˜•ì œ ë…¸ë“œ ì°¸ì¡°
- index : í˜„ì¬ ë…¸ë“œê°€ ë¶€ëª¨ì˜ ìì‹ ë…¸ë“œë“¤ ì¤‘ ëª‡ ë²ˆì§¸ì¸ì§€
- ref : react ref ê°ì²´
- refCleanup : ref í•´ì œ ì‹œì ì— í˜¸ì¶œí•  ì •ë¦¬ í•¨ìˆ˜ ë³µì‚¬

## workLoopSync()

```jsx
function workLoopSync() {
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress);
  }
}
```

í•´ë‹¹ í•¨ìˆ˜ì—ì„œëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ ë£¨í”„ë¥¼ ëˆë‹¤. (ë£¨í”„ì¸ ê²ƒìœ¼ë¡œ ë³´ì•„ ë™ê¸°ì  ë Œë”ì„ì„ ë‹¤ì‹œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.)

## performUnitOfWork

```jsx
function performUnitOfWork(unitOfWork: Fiber): void {
  const current = unitOfWork.alternate;

  let next;
  if (enableProfilerTimer && (unitOfWork.mode & ProfileMode) !== NoMode) {
    // profiler ê´€ë ¨
    // ...
  } else {
    if (__DEV__) {
      // dev ëª¨ë“œ ê´€ë ¨
      // ...
    } else {
      next = beginWork(current, unitOfWork, entangledRenderLanes);
    }
  }

  unitOfWork.memoizedProps = unitOfWork.pendingProps;
  if (next === null) {
    completeUnitOfWork(unitOfWork);
  } else {
    workInProgress = next;
  }
}
```

í•œ ê°œì˜ fiber ë…¸ë“œ ë‹¨ìœ„ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ë‹¤.

**beginWorkë¥¼ í†µí•´ ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰**í•œë‹¤.

Fiberì—ì„œ ì‚¬ìš©ëœ propsë¥¼ memoziedPropsì— ì €ì¥í•œë‹¤.

ì´í›„ ë‹¤ìŒ ìì‹ì´ ì—†ë‹¤ë©´ `completeUnitOfWork` ë¥¼ ìˆ˜í–‰í•˜ë©° ë§ˆì¹œë‹¤.

ìì‹ì´ ìˆë‹¤ë©´ ë‹¤ìŒ ì‘ì—… ëŒ€ìƒìœ¼ë¡œ ì´ë™í•œë‹¤. (ë£¨í”„ì´ë¯€ë¡œ)

ì´ì œ beginWorkì™€ CompleteUnitOfWorkì— ëŒ€í•´ì„œ ì‚´í´ë³´ì.

## beginWork

ì´ í•¨ìˆ˜ë„ ë Œë”ë§ í”„ë¡œì„¸ìŠ¤ë¥¼ ì´í•´í•˜ê¸° ìœ„í•œ ë¶€ë¶„ë§Œ ë³´ë©´,

```jsx
 if (current !== null) {
  // ì´ë¯¸ ë Œë”ëœ ì  ìˆìŒ â†’ ì—…ë°ì´íŠ¸ ì—¬ë¶€ íŒë‹¨ìœ¼ë¡œ ì´ì–´ì§
  ...
} else {
  // current === null â†’ ì´ˆê¸° ë Œë”
  didReceiveUpdate = false;

  // ...
}
```

ì´ˆê¸° ë Œë” ì—¬ë¶€ë¥¼ ìœ„ì˜ ì½”ë“œì—ì„œ í™•ì¸í•´ ë¶„ê¸°í•œë‹¤. ìš°ë¦¬ëŠ” ë¦¬ë Œë”ë§ ê³¼ì •ì„ ì‚´í´ë³´ê³  ìˆìœ¼ë¯€ë¡œ ì—…ë°ì´íŠ¸ ì—¬ë¶€ íŒë‹¨ ë¶€ë¶„ë§Œ ë” ìì„¸íˆ ì‚´í´ë³´ê² ë‹¤.

```jsx
if (current !== null) {
  const oldProps = current.memoizedProps;
  const newProps = workInProgress.pendingProps;

  if (
    oldProps !== newProps ||
    hasLegacyContextChanged() ||
    (__DEV__ ? workInProgress.type !== current.type : false)
  ) {
    // ì—…ë°ì´íŠ¸ í•„ìš”
    didReceiveUpdate = true;
  } else {
    const hasScheduledUpdateOrContext = checkScheduledUpdateOrContext(
      current,
      renderLanes
    );
    if (
      !hasScheduledUpdateOrContext &&
      (workInProgress.flags & DidCapture) === NoFlags
    ) {
      // No pending updates or context. Bail out now.
      didReceiveUpdate = false;
      return attemptEarlyBailoutIfNoScheduledUpdate(
        current,
        workInProgress,
        renderLanes
      );
    }
    if ((current.flags & ForceUpdateForLegacySuspense) !== NoFlags) {
      // ê°•ì œì  ì—…ë°ì´íŠ¸ í•„ìš”
      didReceiveUpdate = true;
    } else {
      didReceiveUpdate = false;
    }
  }
}
```

`current` fiber(ì´ì „ ë Œë” ê²°ê³¼ì˜ fiber)ê°€ ì¡´ì¬í•  ë•Œ, ì´ë²ˆ ë Œë”ë§ì—ì„œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œì§€ íŒë‹¨í•œë‹¤.

ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•˜ì§€ ì•Šì€ ê²½ìš°ëŠ” bail out ë  ìˆ˜ ìˆë‹¤.

bail out ë˜ë©´ ê·¸ ìì‹ ë…¸ë“œë“¤ì€ ëª¨ë‘ ê±´ë„ˆ ë›°ê²Œ ë˜ì–´, ìµœì í™” ëœë‹¤.

(bail outì€ í˜„ì¬ ë…¸ë“œì— ì—…ë°ì´íŠ¸ í•  í•„ìš” ì—†ê³ , ìì‹ ë…¸ë“œë„ ì—…ë°ì´íŠ¸ ì˜ˆì•½ì´ ì—†ì„ ê²½ìš°ì—ë§Œ ìˆ˜í–‰ëœë‹¤.)

```jsx

  switch (workInProgress.tag) {
    case LazyComponent: {
      const elementType = workInProgress.elementType;
      return mountLazyComponent(
        current,
        workInProgress,
        elementType,
        renderLanes,
      );
    }
    case FunctionComponent: {
      const Component = workInProgress.type;
      return updateFunctionComponent(
        current,
        workInProgress,
        Component,
        workInProgress.pendingProps,
        renderLanes,
      );
    }

    // ê·¸ ì™¸ ë‹¤ì–‘í•œ case
    // ...

    case Throw: {
      // This represents a Component that threw in the reconciliation phase.
      // So we'll rethrow here. This might be a Thenable.
      throw workInProgress.pendingProps;
    }
  }

  throw new Error(
    `Unknown unit of work tag (${workInProgress.tag}). This error is likely caused by a bug in ` +
      'React. Please file an issue.',
  );
}

export {beginWork};
```

ê·¸ë¦¬ê³  ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” fiber ë…¸ë“œë“¤ì€ ìœ„ì˜ switch ë¬¸ì„ íƒ€ê³  fiberë¥¼ ì—…ë°ì´íŠ¸ í•˜ëŠ” ë¡œì§ì„ ë”°ë¥¸ë‹¤.

### updateFunctionComponent

```jsx
//...

reconcileChildren(current, workInProgress, nextChildren, renderLanes);
return workInProgress.child;
```

ë‹¤ì–‘í•œ ì—…ë°ì´íŠ¸ ë¡œì§ì´ ìˆì§€ë§Œ í•¨ìˆ˜í˜• ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸ ë¡œì§ì„ ì¼ë¶€ ë³´ë©´

reconcileChildren ë‚´ë¶€ì—ì„œ ì•„ë˜ì™€ ê°™ì€ ë™ì‘ì„ í•œë‹¤. (ë‚´ë¶€ í•¨ìˆ˜ í˜¸ì¶œ í†µí•´ì„œ ..)

- ì´ì „ children(Fiber)ê³¼ ìƒˆë¡œìš´ children(ReactElement)ì„ ë¹„êµ
- **key + type** ë¹„êµ â†’ ì¬ì‚¬ìš© ì—¬ë¶€ ê²°ì •
- ì¬ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ìƒˆë¡œìš´ Fiber ìƒì„±

ì´ë ‡ê²Œ ìƒì„±ëœ child ë…¸ë“œë¥¼ returní•˜ë©´ ì´ì „ ì½”ë“œì—ì„œ ë“±ì¥í–ˆë˜, ì•„ë˜ì™€ ê°™ì´ ë‹¤ìŒ ìˆœíšŒ ëŒ€ìƒì´ ëœë‹¤.

```jsx
next = beginWork(current, unitOfWork, entangledRenderLanes);
```

ì´ ë¶€ë¶„ì— child ë…¸ë“œê°€ ë“¤ì–´ê°€ê²Œ ëœë‹¤.

ìì‹ ë…¸ë“œê°€ ìˆì„ ë•Œê¹Œì§€ëŠ” ê³„ì† íƒìƒ‰í•œë‹¤ëŠ” ê²ƒì´ë‹¤.

ì°¸ê³ ë¡œ bail outëœ ë…¸ë“œëŠ” ì—¬ê¸°ì„œ nextê°€ nullì¼ ê²ƒì´ë‹¤.

```jsx
if (next === null) {
  completeUnitOfWork(unitOfWork);
} else {
  workInProgress = next;
}
```

ê·¸ë¦¬ê³  nextê°€ nullì´ë¼ë©´ ë” ì´ìƒ íƒìƒ‰í•  childê°€ ì—†ë‹¤ëŠ” ëœ»ì´ë¯€ë¡œ completeUnitOfWorkë¥¼ ìˆ˜í–‰í•œë‹¤.

## completeUnitOfWork

```jsx
function completeUnitOfWork(unitOfWork: Fiber): void {
  let completedWork: Fiber = unitOfWork;
  do {
    // ...

    // ...

    if (__DEV__) {
      // ... (ê°œë°œ ëª¨ë“œ)
    } else {
      next = completeWork(current, completedWork, entangledRenderLanes);
    }

    if (next !== null) {
      workInProgress = next; // ìƒˆë¡œìš´ ì¼ ìˆìœ¼ë©´ ë‹¤ì‹œ beginWork
      return;
    }

    const siblingFiber = completedWork.sibling;
    if (siblingFiber !== null) {
      workInProgress = siblingFiber;
      return;
    }

    completedWork = returnFiber;
    workInProgress = completedWork;
  } while (completedWork !== null);

  // ...
}
```

`completeUnitOfWork`ëŠ” DFS íƒìƒ‰ì—ì„œ ë” ì´ìƒ ìì‹ ë…¸ë“œê°€ ì—†ì–´, **ìì‹ë¶€í„° ë¶€ëª¨ ë°©í–¥ìœ¼ë¡œ ì˜¬ë¼ì˜¤ë©´ì„œ** ë‚¨ì€ ì¼ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ë‹¤.

1. siblingFiber (í˜•ì œ ë…¸ë“œ)ê°€ ì¡´ì¬ í•˜ë©´ í•´ë‹¹ ë…¸ë“œë¡œ ì´ë™í•˜ê³ ,
2. í˜•ì œ ë…¸ë“œê°€ ì—†ë‹¤ë©´ ë¶€ëª¨ ë…¸ë“œ(returnFiber)ë¡œ ì´ë™í•œë‹¤.

ì´ì œ ìœ„ì˜ ì½”ë“œì—ì„œ ìì‹ ë…¸ë“œê°€ ë” ì´ìƒ ì—†ì–´ ìˆ˜í–‰í•˜ëŠ” completeWorkì— ëŒ€í•´ì„œ ì‚´í´ë³¸ë‹¤.

### completeWork

```jsx
function completeWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderLanes: Lanes,
): Fiber | null {
  const newProps = workInProgress.pendingProps;
  switch (workInProgress.tag) {

    case FunctionComponent:
    case ForwardRef:
    case SimpleMemoComponent:
      // ê¸°ë³¸ì ìœ¼ë¡œ íŠ¹ë³„í•œ ì‘ì—… ì—†ì´ ê·¸ëŒ€ë¡œ ë¦¬í„´
      return null;

    case HostComponent: {
      if (current !== null && workInProgress.stateNode != null) {
        // ê¸°ì¡´ DOMì´ ìˆìœ¼ë©´ propsë§Œ ì—…ë°ì´íŠ¸
        // ... ìƒëµ
      } else {
        // ìµœì´ˆ ë§ˆìš´íŠ¸ì¼ ê²½ìš° DOM ë…¸ë“œ ìƒì„±
        const type = workInProgress.type;
        const instance = createInstance(type, newProps, ...);
        appendAllChildren(instance, workInProgress);
        finalizeInitialChildren(instance, type, newProps, ...);
        workInProgress.stateNode = instance;
      }
      return null;
    }

    case HostText: {
      if (current === null) {
        const text = newProps;
        workInProgress.stateNode = createTextInstance(text, ...);
      }
      return null;
    }

    case HostRoot: {
      // ë£¨íŠ¸ ì²˜ë¦¬ (ì˜ˆ: context, ì—…ë°ì´íŠ¸ ì²˜ë¦¬ ë“±)
      // ... ìƒëµ
      return null;
    }

    case SuspenseComponent: {
      // Suspense ì²˜ë¦¬
      // ... ìƒëµ
      return null;
    }

    // ... ê¸°íƒ€ ì¼€ì´ìŠ¤ ìƒëµ
  }
}
```

completeWork ì—ì„œëŠ” ìœ„ì™€ ê°™ì´ ì¼€ì´ìŠ¤ ë³„ë¡œ ë³€ê²½ì‚¬í•­ì„ Fiberì— ë°˜ì˜í•´ë‘”ë‹¤.

ì´ê±¸ ì‹¤ì œ DOMì— ë°˜ì˜í•˜ëŠ” ê²ƒì€ ì»¤ë°‹ ë‹¨ê³„ì—ì„œ ì§„í–‰í•œë‹¤.

---

# performSyncWorkOnRoot

```jsx
function performSyncWorkOnRoot(root) {
  const exitStatus = renderRootSync(root, SyncLane);

  if (exitStatus === RootCompleted) {
    // ë Œë” ì„±ê³µí–ˆìœ¼ë‹ˆ ì»¤ë°‹ ë‹¨ê³„ë¡œ ë„˜ì–´ê°
    commitRoot(root);
  } else {
    // Suspenseë‚˜ ì—ëŸ¬ë¡œ ì¸í•œ ì¤‘ë‹¨ ìƒíƒœ ì²˜ë¦¬
    // ì¬ì‹œë„í•˜ê±°ë‚˜ fallback ì²˜ë¦¬ ë“±
  }
}
```

ì§€ê¸ˆê¹Œì§€ ë´¤ë˜ renderRootSyncëŠ” exitStatusë¥¼ ë°˜í™˜í•˜ê³ , ì„±ê³µí–ˆë‹¤ë©´ ì»¤ë°‹ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ê²Œ ëœë‹¤.

## commitRoot

```jsx
function commitRoot(root) {
  const finishedWork = root.finishedWork; // ì‘ì—… ì™„ë£Œëœ Fiber íŠ¸ë¦¬
  const lanes = root.finishedLanes;

  // 1. before mutation phase
  commitBeforeMutationEffects(finishedWork);

  // 2. mutation phase
  commitMutationEffects(finishedWork, root, lanes);

  // 3. layout phase
  commitLayoutEffects(finishedWork, root, lanes);

  // 4. ë£¨íŠ¸ ìƒíƒœ ì •ë¦¬ ë° í˜„ì¬ ì‘ì—… ì¤‘ì¸ Fiber ì—…ë°ì´íŠ¸
  root.current = finishedWork; // ì‘ì—… ì™„ë£Œ Fiber íŠ¸ë¦¬ë¥¼ í˜„ì¬ Fiberë¡œ ì„¤ì •
  root.finishedWork = null;
  root.finishedLanes = NoLanes;

  // 5. ì´í›„ ìŠ¤ì¼€ì¤„ë§ ë“± í›„ì²˜ë¦¬
}
```

ì»¤ë°‹ ë‹¨ê³„ì—ì„œëŠ” ì‹¤ì œ DOM ì¡°ì‘ì´ ë°œìƒí•˜ê³ ,
layout effectë¥¼ ì‹¤í–‰ (ì˜ˆ: `useLayoutEffect` í›… ì‹¤í–‰)í•˜ê³ ,

ê·¸ë¦¬ê³  ì»¤ë°‹ ì™„ë£Œ í›„ currentì— WorkInProgressë¥¼ í• ë‹¹í•œë‹¤.

# ì •ë¦¬

1. current fiber íŠ¸ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ WorkInProgress íŠ¸ë¦¬ ìƒì„±í•˜ëŠ”ë°, ì´ë•Œ fiber ë…¸ë“œë“¤ì€ ì¬ì‚¬ìš©ë  ìˆ˜ ìˆìŒ (alternateë¡œ ì—°ê²°ë˜ì–´ ìˆì–´ì„œ)

2. ìƒì„± í›„ ë™ê¸°ì  ë Œë” ìˆ˜í–‰, WorkInProgress íŠ¸ë¦¬ë¥¼ ìˆœíšŒí•˜ë©° ê° fiberì˜ ì—…ë°ì´íŠ¸ í•„ìš” ì—¬ë¶€ íŒë‹¨í•œë‹¤.

- ìˆœíšŒí•  ë•Œ beginWork()ì—ì„œ fiber ì—…ë°ì´íŠ¸ í•„ìš” ì—¬ë¶€ íŒë‹¨í•´ì„œ ì—…ë°ì´íŠ¸
- **ì—…ë°ì´íŠ¸ í•„ìš”í•˜ë‹¤ê³  ì—¬ê²¨ì§€ë©´? (ex. propsê°€ ë°”ë€œ, keyê°€ ë°”ë€œ)**
  1. ì»´í¬ë„ŒíŠ¸ íƒ€ì…ì— ë”°ë¼ ì•Œë§ì€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì‹¤í–‰
  2. ì»´í¬ë„ŒíŠ¸ í•¨ìˆ˜ ì‹¤í–‰ ë° ìì‹ ìš”ì†Œë“¤ ë°˜í™˜, ìì‹ìš”ì†Œë“¤ ë˜í•œ fiber ë…¸ë“œë¡œ ë³€í™˜ë˜ì–´ workInProgress.childë¡œ ì—°ê²°ë¨
  3. ê¸°ì¡´ current.childì™€ ë¹„êµí•˜ì—¬ í•´ë‹¹ ìì‹ ë…¸ë“œì— flags ì„¤ì • (Placement, Update, ...)
  4. ì²« ìì‹ fiberê°€ ë°˜í™˜ë˜ë©°, ë‹¤ìŒ beginWork() ëŒ€ìƒ
- ì—…ë°ì´íŠ¸ í•„ìš”ì—†ë‹¤ê³  ì—¬ê²¨ì§„ë‹¤ë©´ bail out ë˜ì–´ ìì‹ ë…¸ë“œë“¤ë„ ìˆœíšŒí•˜ì§€ ì•ŠëŠ”ë‹¤.
- ë” ì´ìƒ ìˆœíšŒí•  ìì‹ ë…¸ë“œê°€ ì—†ë‹¤ë©´ completeWork() ìˆ˜í–‰í•˜ë©° fiber ë…¸ë“œ ìì²´ì— ì—…ë°ì´íŠ¸ ì •ë³´ë¥¼ ì €ì¥í•´ë‘ .
- completeWork ìˆ˜í–‰ í›„ í˜•ì œ ë…¸ë“œê°€ ìˆë‹¤ë©´ í•´ë‹¹ ë…¸ë“œë¡œ beginWork() ìˆ˜í–‰í•´ ì²˜ë¦¬
- ë” ì´ìƒ ì²˜ë¦¬í•  ë…¸ë“œê°€ ë˜ ì—†ë‹¤ë©´ ë¶€ëª¨ ë…¸ë“œë¡œ ëŒì•„ê°€ completeWork()
- ìµœì¢…ì ìœ¼ë¡œ commitWork ìˆ˜í–‰

3. ìˆœíšŒê°€ ëë‚˜ë©´ ì»¤ë°‹ ë‹¨ê³„ì—ì„œëŠ” ë³€ê²½ í”Œë˜ê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ì œ DOMì„ ì¡°ì‘í•˜ê±°ë‚˜, useLayoutEffect ê°™ì€ ì‚¬ì´ë“œì´í™íŠ¸ë¥¼ ì‹¤í–‰,Â  ìµœì¢…ì ìœ¼ë¡œ current íŠ¸ë¦¬ë¥¼ WorkInProgress íŠ¸ë¦¬ë¡œÂ **ìŠ¤ì™‘**í•˜ë©° ë Œë”ë§ì´ ì™„ê²°ëœë‹¤.

## ì˜¤ëŠ˜ì˜ íšŒê³ 

ì˜¤ëŠ˜ì€ React ì½”ë“œë¥¼ ì²˜ìŒ ëœ¯ì–´ë³¸ ì—­ì‚¬ì ì¸ ë‚ ì´ë‹¤ ^.^

í•˜ì§€ë§Œ ì—­ì‹œ ì–´ë µê¸´ í•˜ë‹¤..

ë„ì—„ë„ì—„ ë³´ê²Œ ëì§€ë§Œ .. ê·¸ë˜ë„ í—·ê°ˆë ¸ë˜ ê²ƒë“¤ì„ ì–´ëŠ ì •ë„ ì´í•´í•˜ê²Œ ëœ ê²ƒ ê°™ì•„ì„œ ë¿Œë“¯í•˜ë‹¤.
